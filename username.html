<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Autosave_</title>
<style>
body {
  margin: 0;
  background: #111 url('https://cnozv.github.io/background_white%20(2).png') center/cover no-repeat;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
}
canvas {
  display: block;
  border: 2px solid #C29557;
  background: transparent;
  cursor: crosshair;
  touch-action: none;
  margin: 20px auto;
}
.controls {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}
button {
  padding: 8px 16px;
  font-size: 14px;
  background: #C29557;
  border: none;
  border-radius: 4px;
  color: white;
  cursor: pointer;
}
button:hover {
  background: #AF7613;
}
label {
  font-size: 14px;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<div class="controls">
  <div style="display: flex; align-items: center; gap: 5px;">
    <label for="colorPicker">ì„  ìƒ‰ìƒ:</label>
    <input type="color" id="colorPicker" value="#000000">
  </div>
  <button id="penButton">íœ</button>
  <button id="eraserButton">ì§€ìš°ê°œ</button>
  <button id="clearButton">ì „ì²´ ì§€ìš°ê¸°</button>
  <button id="saveButton" style="margin-left: 20px;">ì¿ í‚¤ ì €ì¥í•˜ê¸°</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let drawing = false;
let lastX = 0;
let lastY = 0;
let currentColor = document.getElementById('colorPicker').value;
let isErasing = false;

// ìº”ë²„ìŠ¤ í¬ê¸° ê³ ì •
function resizeCanvas() {
  const width = 700;
  const height = 500;
  canvas.width = width;
  canvas.height = height;
  canvas.style.width = width + "px";
  canvas.style.height = height + "px";
}
resizeCanvas();

// ìƒ‰ìƒ ì„ íƒ
document.getElementById('colorPicker').addEventListener('input', e => {
  currentColor = e.target.value;
  isErasing = false;
});

// íœ ë²„íŠ¼
document.getElementById('penButton').addEventListener('click', () => {
  isErasing = false;
});

// ì§€ìš°ê°œ ë²„íŠ¼
document.getElementById('eraserButton').addEventListener('click', () => {
  isErasing = true;
});

// ì „ì²´ ì§€ìš°ê¸°
document.getElementById('clearButton').addEventListener('click', () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  isErasing = false;
});

// ì„  ê·¸ë¦¬ê¸°
function drawLine(x1, y1, x2, y2) {
  ctx.beginPath();
  ctx.moveTo(x1, y1);
  ctx.lineTo(x2, y2);
  ctx.lineCap = 'round';

  if (isErasing) {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
    ctx.lineWidth = 10;
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = 10;
  }

  ctx.stroke();
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
canvas.addEventListener('mousedown', e => {
  drawing = true;
  [lastX, lastY] = [e.offsetX, e.offsetY];
});
canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mouseout', () => drawing = false);
canvas.addEventListener('mousemove', e => {
  if (!drawing) return;
  drawLine(lastX, lastY, e.offsetX, e.offsetY);
  [lastX, lastY] = [e.offsetX, e.offsetY];
});

// í„°ì¹˜ ì´ë²¤íŠ¸
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  drawing = true;
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  lastX = touch.clientX - rect.left;
  lastY = touch.clientY - rect.top;
});
canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!drawing) return;
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  drawLine(lastX, lastY, x, y);
  lastX = x;
  lastY = y;
});
canvas.addEventListener('touchend', e => {
  e.preventDefault();
  drawing = false;
});

// ì¿ í‚¤ ì €ì¥
document.getElementById('saveButton').onclick = async () => {
  ctx.globalCompositeOperation = 'source-over';
  isErasing = false;

  const imgData = canvas.toDataURL('image/png');

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbywTV8VXa0QDLJypbi1mdSaQw5nIuDbM9q8FpiBzXtEcms-MJChuvLXVFebDbArnBUv/exec", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: "imgdata=" + encodeURIComponent(imgData),
    });

    const text = await response.text(); // ğŸ’¡ JSON ëŒ€ì‹  textë¡œ ë¨¼ì € ë°›ê¸°
    console.log("ì„œë²„ ì‘ë‹µ:", text); // ğŸ’¡ ì½˜ì†”ì— ì¶œë ¥

    if (!response.ok) {
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì„œë²„ ì‘ë‹µ: " + text);
      return;
    }

    // JSON íŒŒì‹± ì‹œë„
    const result = JSON.parse(text);
    const count = result.count;

    alert(`ì¿ í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\ní˜„ì¬ê¹Œì§€ ë‚¨ê²¨ì§„ ì¿ í‚¤ ìˆ˜ : ${count}`);

    ctx.clearRect(0, 0, canvas.width, canvas.height);

  } catch (error) {
    console.error("ì—ëŸ¬:", error);
    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
};

</script>

</body>
</html>
